<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ç•¢æ¥­æ™šæœƒï½œè¨±é¡˜ç‰†</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css">
<style>
  :root{--bd:#e5e7eb;--muted:#6b7280}
  body{font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:#fafafa;color:#111827}
  .wrap{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:28px;margin:0 0 6px 0}
  .sub{color:var(--muted);margin:0 0 18px 0}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .card{border:1px solid var(--bd);border-radius:14px;padding:14px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.02)}
  .pill{font-size:12px;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;margin-left:6px}
  .like{cursor:pointer;border:1px solid var(--bd);border-radius:10px;padding:4px 8px;font-size:12px;background:#fff}
  .pinned{border-color:#f59e0b}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select{padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fff}
  .empty{border:1px dashed var(--bd);border-radius:14px;padding:24px;text-align:center;color:var(--muted);background:#fff}
  .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .spinner{width:26px;height:26px;border:3px solid var(--bd);border-top-color:#111827;border-radius:50%;animation:spin 1s linear infinite;margin:12px auto}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ç•¢æ¥­æ™šæœƒè¨±é¡˜ç‰†</h1>
  <p class="sub">å…ˆå¡«è¡¨å–®é€å‡ºä½ çš„é¡˜æœ›ï¼Œé€šéå¯©æ ¸å¾Œæœƒå‡ºç¾åœ¨ä¸‹é¢çš„ç‰†é¢ã€‚</p>

  <div style="border:1px solid var(--bd);border-radius:14px;overflow:hidden;background:#fff">
    <iframe
      src="https://docs.google.com/forms/d/e/1FAIpQLSf1MH78YWa2CKkk88zn8dOQ9I4LNIw1RyMC49mECKlp9x3ZJw/viewform?embedded=true"
      width="100%" height="640" frameborder="0" marginheight="0" marginwidth="0"
      title="ç•¢æ¥­æ™šæœƒè¨±é¡˜è¡¨å–®">è¼‰å…¥ä¸­â€¦</iframe>
  </div>

  <hr style="margin:24px 0">

  <div class="toolbar">
    <label class="sr-only" for="q">æœå°‹</label>
    <input id="q" placeholder="æœå°‹é—œéµå­—â€¦ (å…§å®¹æˆ–ç½²å)">
    <label class="sr-only" for="cat">é¡åˆ¥</label>
    <select id="cat">
      <option value="">å…¨éƒ¨é¡åˆ¥</option>
      <option>ç¥ç¦</option><option>æ©‹æ®µ</option><option>æ„Ÿè¬</option><option>é»æ­Œ</option><option>å…¶ä»–</option>
    </select>
    <button id="refresh" class="like" title="é‡æ–°æ•´ç†">â†» é‡æ–°æ•´ç†</button>
  </div>

  <div id="loading" class="spinner" aria-label="è¼‰å…¥ä¸­" role="status"></div>
  <div id="list" class="grid" style="margin-top:16px;display:none"></div>
  <div id="empty" class="empty" style="display:none">ç›®å‰é‚„æ²’æœ‰å…¬é–‹çš„é¡˜æœ›ï¼Œæˆ–é—œéµå­—æ²’æœ‰åŒ¹é…çµæœã€‚</div>
</div>

<script>
/* Apps Script /exec ç¶²å€ï¼ˆä¸åŠ  callbackï¼‰ */
const API = 'https://script.google.com/macros/s/AKfycby50qefFtzsgoZ-uAIiOhFTGpdj5vfvrMCzbWADKhDHVVKpb1pztnnRQ3pd1fZ2NUa3zQ/exec';

const list = document.getElementById('list');
const q = document.getElementById('q');
const cat = document.getElementById('cat');
const loading = document.getElementById('loading');
const empty = document.getElementById('empty');
const refreshBtn = document.getElementById('refresh');

let wishes = [], filtered = [];
const likes = JSON.parse(localStorage.getItem('likes') || '{}');   // æœ¬æ©Ÿç´¯è¨ˆå€¼ï¼ˆé¡¯ç¤ºç”¨ï¼‰
const liked = JSON.parse(localStorage.getItem('liked') || '{}');   // æœ¬æ©Ÿæ˜¯å¦å·²æŒ‰é

function escapeHtml(str){
  return (str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
function render(){
  list.innerHTML = '';
  if(filtered.length === 0){
    list.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  list.style.display = 'grid';

  filtered.forEach(w=>{
    const div = document.createElement('div');
    div.className = 'card' + (w.pinned ? ' pinned' : '');
    const localCnt = likes[w.id] || 0;
    const totalCnt = (w.likeCount || 0) + localCnt;
    const disabled = liked[w.id] ? 'disabled' : '';
    div.innerHTML =
      '<div class="row">' +
        '<strong>' + escapeHtml(w.name || 'åŒ¿å') + '</strong>' +
        '<span class="pill">' + escapeHtml(w.category || 'å…¶ä»–') + '</span>' +
      '</div>' +
      '<p style="white-space:pre-wrap;margin:8px 0 12px 0">' + escapeHtml(w.content || '') + '</p>' +
      '<div class="row">' +
        '<small style="color:var(--muted)">' + (w.created_at ? new Date(w.created_at).toLocaleString() : '') + '</small>' +
        '<button class="like" data-id="' + w.id + '" ' + disabled + '>ğŸ‘ ' + totalCnt + '</button>' +
      '</div>';
    list.appendChild(div);
  });
}
function applyFilter(){
  const term = (q.value || '').toLowerCase();
  const c = cat.value;
  filtered = wishes.filter(w=>{
    const okCat = !c || (w.category || '') === c;
    const okText = !term
      || (w.content || '').toLowerCase().includes(term)
      || (w.name || '').toLowerCase().includes(term);
    return okCat && okText;
  });
  filtered.sort((a,b)=> (Number(b.pinned) - Number(a.pinned))
    || (new Date(b.created_at || 0) - new Date(a.created_at || 0)));
  render();
}

/* JSONP è®€å–æ¸…å–® */
function jsonp(url, cb){
  const name = 'jsonp_' + Math.random().toString(36).slice(2);
  window[name] = function(data){
    try { cb(null, data); } finally {
      delete window[name];
      if (script && script.parentNode) script.parentNode.removeChild(script);
    }
  };
  const script = document.createElement('script');
  script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + name;
  script.onerror = function(){ cb(new Error('JSONP failed')); };
  document.body.appendChild(script);
}
function load(){
  loading.style.display = 'block';
  list.style.display = 'none';
  empty.style.display = 'none';
  jsonp(API, function(err, data){
    loading.style.display = 'none';
    if (err || !data || !data.wishes) {
      empty.textContent = 'è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ JSON URLã€‚';
      empty.style.display = 'block';
      return;
    }
    wishes = data.wishes;
    applyFilter();
  });
}

/* JSONP é€å‡ºæŒ‰è®šï¼ˆå…¨å ´å…±ç”¨ï¼‰ */
function sendLike(id, buttonEl){
  if (liked[id]) return; // æœ¬æ©Ÿé˜²é‡
  // å…ˆç«‹å³æ›´æ–°æœ¬åœ°é¡¯ç¤º
  likes[id] = (likes[id] || 0) + 1;
  localStorage.setItem('likes', JSON.stringify(likes));
  liked[id] = true;
  localStorage.setItem('liked', JSON.stringify(liked));
  // æ›´æ–°æŒ‰éˆ•æ•¸å­—
  const current = parseInt(buttonEl.textContent.replace(/[^\d]/g,'')) || 0;
  buttonEl.textContent = 'ğŸ‘ ' + (current + 1);
  buttonEl.setAttribute('disabled','');

  // é€šçŸ¥å¾Œç«¯ç´¯åŠ ï¼ˆä¸å— CORSï¼‰
  jsonp(API + '?action=like&id=' + encodeURIComponent(id), function(err, res){
    // ä¸ç®¡æˆåŠŸå¤±æ•—ï¼Œå‰ç«¯é¡¯ç¤ºå·²æ›´æ–°ï¼›è‹¥æƒ³åš´è¬¹å¯åœ¨ err æ™‚å›æ»¾
    if (res && res.ok) {
      // å¯é¸ï¼šä»¥å¾Œé‡æ–° load æ™‚æœƒæ‹¿åˆ°æœ€æ–°ç‰ˆ likeCount
    }
  });
}

/* äº‹ä»¶ */
document.addEventListener('click', function(e){
  if(e.target.classList.contains('like')){
    const id = e.target.getAttribute('data-id');
    if (liked[id]) return; // å·²æŒ‰é
    sendLike(id, e.target);
  }
});
q.addEventListener('input', applyFilter);
cat.addEventListener('change', applyFilter);
refreshBtn.addEventListener('click', load);

/* é¦–æ¬¡è¼‰å…¥ */
load();
</script>
</body>
</html>
